<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Morning Soul est une plateforme communautaire immersive mêlant jeu narratif, tutoriels, devblog et forum. Rejoignez l’aventure.">
    <title>{% block title %}- Morning Soul -{% endblock %}</title>
    <link rel="icon" type="image/png" href="{{ asset('/img/favicon_ms_00.png') }}">
    <link rel="stylesheet" href="{{ asset('css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ asset('css/fonts.css') }}">
    <link rel="stylesheet" href="{{ asset('css/navbar.css') }}">
    <link rel="stylesheet" href="{{ asset('css/footer.css') }}">
    <link rel="stylesheet" href="{{ asset('css/base.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    {% block stylesheets %}
      <style>
        .flash-overlay {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 1050;
          width: 100%;
          max-width: 400px;
          padding: 1rem;
          animation: fadeIn 0.4s ease-out;
        }

        .flash-overlay .alert {
          margin: 0;
          box-shadow: 0 0 20px rgba(0,0,0,0.2);
          border-radius: 8px;
          font-size: 1.1rem;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translate(-50%, -60%); }
          to { opacity: 1; transform: translate(-50%, -50%); }
        }

        .cookie-banner {
          position: fixed;
          bottom: 20px;
          width: 100%;
          z-index: 9999;
        }

        .badge-admin{background-color:#2196f3;color:#fff;padding:2px 6px;font-size:.75rem;border-radius:4px;margin-left:6px}
        .badge-super{background-color:#e91e63;color:#fff;padding:2px 6px;font-size:.75rem;border-radius:4px;margin-left:6px}
      </style>
    {% endblock %}

    {% block structured_data %}{% endblock %}
  </head>

  <body class="site-background">
    <div class="page-wrapper">
      {% for label, messages in app.flashes %}
        {% for message in messages %}
          <div class="flash-overlay">
            <div class="alert alert-{{ label }} text-center" role="alert">
              {{ message }}
            </div>
          </div>
        {% endfor %}
      {% endfor %}

      {% include "_inc/header.html.twig" %}

      <main>
        {% block body %}{% endblock %}
      </main>

      {% include "_inc/footer.html.twig" %}
    </div>

{% if app.request.attributes.get('_route') not in ['cookies.preferences', 'legal.privacy'] %}
  <div id="cookie-banner" class="cookie-banner d-none">
    <div class="cookie-content bg-light p-3 border rounded shadow-sm">
      <p class="mb-2">
        Morning Soul utilise des cookies pour améliorer votre expérience.
        Vous pouvez accepter, refuser ou personnaliser vos préférences.
      </p>
      <div class="d-flex gap-2">
        <button id="cookie-accept" class="btn btn-success btn-sm">Tout accepter</button>
        <button id="cookie-refuse" class="btn btn-danger btn-sm">Tout refuser</button>
        <button id="cookie-customize" class="btn btn-secondary btn-sm">Personnaliser</button>
      </div>
    </div>
  </div>
{% endif %}

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    {% block javascripts %}
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const flash = document.querySelector('.flash-overlay');
          if (flash) {
            setTimeout(() => {
              flash.style.opacity = '0';
              flash.style.transition = 'opacity 0.5s ease';
              setTimeout(() => flash.remove(), 500);
            }, 3000);
          }

          document.querySelectorAll('a[href^="http"]:not(.no-intercept)').forEach(link => {
            const hostname = window.location.hostname;
            if (!link.href.includes(hostname)) {
              link.addEventListener('click', e => {
                e.preventDefault();
                const target = encodeURIComponent(link.href);
                window.location.href = `/redirect?target=${target}`;
              });
            }
          });

          const banner = document.getElementById("cookie-banner");
          const consent = localStorage.getItem("cookieConsent");

          function activateCookies() {
            console.log("Cookies activés");
          }

          function deactivateCookies() {
            console.log("Cookies refusés");
          }

          if (!consent) {
            banner.classList.remove("d-none");
          } else if (consent === "accepted") {
            activateCookies();
          } else if (consent === "refused") {
            deactivateCookies();
          }

document.getElementById("cookie-accept").addEventListener("click", function () {
  localStorage.setItem("cookieConsent", "accepted");

  fetch("/cookies/save", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({ consent: "accepted" })
  });

  banner.style.opacity = '0';
  banner.style.transition = 'opacity 0.5s ease';
  setTimeout(() => banner.classList.add("d-none"), 500);

  activateCookies();
});

document.getElementById("cookie-refuse").addEventListener("click", function () {
  localStorage.setItem("cookieConsent", "refused");

  fetch("/cookies/save", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({ consent: "refused" })
  });

  banner.style.opacity = '0';
  banner.style.transition = 'opacity 0.5s ease';
  setTimeout(() => banner.classList.add("d-none"), 500);

  deactivateCookies();
});

          document.getElementById("cookie-customize").addEventListener("click", function () {
            window.location.href = "{{ path('cookies.preferences') }}";
          });
        });
      </script>
    {% endblock %}
  </body>
</html>