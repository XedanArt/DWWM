{% extends 'base.html.twig' %}

{% block body %}
<div class="dashboard-wrapper">
  <h1 class="dashboard-title">Tableau de bord</h1>

  {% if is_granted('ROLE_ADMIN') %}
    <section class="dashboard-section">
      <h2>Gestion des utilisateurs</h2>
      {% if users is defined and users|length > 0 %}
        <ul class="user-list scrollable-user-list">
          {% for user in users %}
            <li class="user-item">
              <span>{{ user.displayUsername }}</span>
              <button class="user-toggle" onclick="toggleUserMenu('{{ user.id }}')">▼</button>

              <div id="user-menu-{{ user.id }}" class="user-menu hidden">
                <p>Dernière connexion :
                  {% if user.lastLogin is not null %}
                    {{ user.lastLogin|date('d/m/Y H:i') }}
                  {% else %}
                    Jamais
                  {% endif %}
                </p>
                <p>Derniers topics : {{ user.topics is defined ? user.topics|length : 0 }}</p>
                <p>Derniers posts : {{ user.posts is defined ? user.posts|length : 0 }}</p>

                <div class="user-actions">
                  <a href="{{ path('dashboard.contact_user', { id: user.id }) }}">Contacter</a>

                  <form method="post" action="{{ path('dashboard.ban_user', { id: user.id, duration: 24 }) }}" class="confirm-action">
                    <input type="hidden" name="_token" value="{{ csrf_token('ban-24-' ~ user.id) }}">
                    <button type="submit" class="btn btn-warning btn-sm">Bannir 24h</button>
                  </form>

                  <form method="post" action="{{ path('dashboard.ban_user', { id: user.id, duration: 48 }) }}" class="confirm-action">
                    <input type="hidden" name="_token" value="{{ csrf_token('ban-48-' ~ user.id) }}">
                    <button type="submit" class="btn btn-warning btn-sm">Bannir 48h</button>
                  </form>

                  <form method="post" action="{{ path('dashboard.delete_user', { id: user.id }) }}" class="confirm-action">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete-' ~ user.id) }}">
                    <button type="submit" class="btn btn-danger btn-sm">Supprimer</button>
                  </form>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>Aucun utilisateur à afficher pour le moment.</p>
      {% endif %}
      <div class="alphabet-filter">
        {% for letter in 'A'..'Z' %}
        <button class="alphabet-button" onclick="filterUsersByLetter('{{ letter }}')">{{ letter }}</button>
        {% endfor %}
        <button class="alphabet-button reset" onclick="resetUserFilter()">Tous</button>
      </div>
    </section>

    <section class="dashboard-section">
      <h2>Gestion contenu utilisateur</h2>
      <ul class="dashboard-actions">
        <li>
          <a href="{{ path('topic.quarantine.list') }}" class="btn btn-primary">
             Voir les topics en quarantaine
          </a>
        </li>
      </ul>
    </section>

    <section class="dashboard-section">
      <h2>Gérer le contenu</h2>
      <ul class="dashboard-actions">
        <li><a href="{{ path('admin.devblog.new') }}" class="btn btn-primary">Ajouter un Devblog</a></li>
        <li><a href="{{ path('admin.changelog.new') }}" class="btn btn-primary">Ajouter un Changelog</a></li>
        <li><a href="{{ path('admin.announcement.new') }}" class="btn btn-primary">Ajouter une annonce</a></li>
        <li><a href="{{ path('admin.entry.delete') }}" class="btn btn-danger">
              <i class="bi bi-trash3-fill me-1"></i> Suppression d'une entrée
            </a>
        </li>
      </ul>
    </section>
  {% endif %}

  {% if is_granted('ROLE_SUPER_ADMIN') %}
    <section class="dashboard-section super-admin-panel">
      <h2>Panel Super Admin</h2>
      <ul class="dashboard-actions">
        <li><a href="{{ path('superadmin.create_admin') }}" class="btn btn-primary">Créer un administrateur</a></li>
        <li><a href="{{ path('superadmin.revoke_admin') }}" class="btn btn-danger">Révoquer un administrateur</a></li>
      </ul>
    </section>
  {% endif %}
</div>

<script>
function toggleUserMenu(id) {
  const menu = document.getElementById('user-menu-' + id);
  menu.classList.toggle('hidden');
}

function filterUsersByLetter(letter) {
  const users = document.querySelectorAll('.user-item');
  users.forEach(user => {
    const username = user.querySelector('span').textContent.trim().toUpperCase();
    user.style.display = username.startsWith(letter) ? 'block' : 'none';
  });
}

function resetUserFilter() {
  const users = document.querySelectorAll('.user-item');
  users.forEach(user => user.style.display = 'block');
}

// Confirmation pour les actions sensibles
document.querySelectorAll('form.confirm-action').forEach(form => {
  form.addEventListener('submit', function (e) {
    const confirmed = confirm("Êtes-vous sûr de vouloir effectuer cette action ?");
    if (!confirmed) {
      e.preventDefault();
    }
  });
});
</script>
{% endblock %}